<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>OrderTech — Admin • Posters</title>
    <link rel="stylesheet" href="/css/admin.css" />
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" />
    <script src="/config.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  </head>
  <body>
    <header class="topbar">
      <nav class="breadcrumbs"><span>Marketing</span><span class="sep">›</span><span>Posters</span></nav>
      <div class="searchbar">
        <select id="tenantSelect" class="select"></select>
      </div>
      <button class="btn icon ghost only-mobile" id="mobileMenu" aria-label="Toggle menu">☰</button>
    </header>
    <main class="main" style="padding:16px;">
      <section class="card">
<div class="body">
          <div class="toolbar"><div class="title" style="font-weight:700;">Posters</div><span class="spacer"></span></div>
          <p class="lead">Manage posters shown on Displays when idle.</p>
          <div class="row" style="gap:10px; align-items:center; flex-wrap:wrap;">
            <div style="display:flex; align-items:center; gap:8px;">
              <input id="file" type="file" accept="image/*" capture="environment" multiple />
              <button id="btnUpload" class="btn">Add</button>
            </div>
          </div>
          <div id="status" class="muted">—</div>
          <div class="row" style="gap:12px; align-items:flex-end; margin-top:8px;">
            <label class="grid"><span class="label">Auto Start</span>
              <label class="switch"><input id="posterAutoStart" type="checkbox" /> Enable poster auto start</label>
            </label>
            <label class="grid"><span class="label">Transition</span>
              <select id="posterTransition" class="select">
                <option value="fade">Fade</option>
                <option value="none">None</option>
              </select>
            </label>
            <label class="grid"><span class="label">Interval (seconds)</span>
              <input id="posterIntervalSec" class="input" type="number" min="2" max="600" step="1" value="8" />
            </label>
            <button id="savePosterSettings" class="btn">Save</button>
          </div>
          <div id="posterGrid" class="poster-grid" style="margin-top:12px;"></div>
        </div>
      </section>
    </main>

    <script src="/js/admin-shell.js?v=20250904-2"></script>
    <script src="/js/admin-common.js?v=20250904-2"></script>
    <script>
      const MAX_BYTES = 5 * 1024 * 1024; // 5 MB
      let DEFAULT_POSTER_URL = '/poster-default.png';
      function renderPosters(items){
        const grid = document.getElementById('posterGrid');
        grid.innerHTML = '';
        const arr = Array.isArray(items) ? items : [];
          if (!arr.length) {
            // default poster only (no delete)
            const card = document.createElement('div'); card.className = 'poster-card';
            const img = document.createElement('img'); img.loading='lazy'; img.decoding='async'; img.alt='Poster'; img.src = DEFAULT_POSTER_URL || '/poster-default.png';
            card.appendChild(img); grid.appendChild(card);
            return;
          }
        arr.forEach(it => {
          const card = document.createElement('div'); card.className = 'poster-card';
          const img = document.createElement('img'); img.loading='lazy'; img.decoding='async'; img.alt='Poster'; img.src = it.url;
          const del = document.createElement('button'); del.type='button'; del.className='del'; del.title='Delete'; del.innerHTML = '<i class="ri-delete-bin-6-line"></i>';
          del.addEventListener('click', async (e)=>{
            e.stopPropagation();
            const tid = Admin.STATE.selectedTenantId; if (!tid) return;
            try { await Admin.api(`/admin/tenants/${encodeURIComponent(tid)}/posters?object=${encodeURIComponent(it.object)}`, { method:'DELETE', tenantId: tid }); Admin.toast('Deleted'); loadPosters().catch(()=>{}); } catch { Admin.toast('Delete failed'); }
          });
          card.appendChild(img); card.appendChild(del); grid.appendChild(card);
        });
      }
      async function loadPosters(){
        const tid = Admin.STATE.selectedTenantId; if (!tid) { renderPosters([]); return; }
        try { const r = await Admin.api(`/admin/tenants/${encodeURIComponent(tid)}/posters`, { tenantId: tid }); renderPosters(r.items||[]); } catch { renderPosters([]); }
      }
      async function loadPosterSettings(){
        const tid = Admin.STATE.selectedTenantId; if (!tid) return;
        try {
          const st = await Admin.api('/drive-thru/state', { tenantId: tid });
          const tSel = document.getElementById('posterTransition');
          const iEl = document.getElementById('posterIntervalSec');
          const aEl = document.getElementById('posterAutoStart');
          if (aEl) aEl.checked = !!st.posterOverlayEnabled;
          if (tSel) tSel.value = (st.posterTransitionType||'fade');
          if (iEl) iEl.value = Math.max(2, Math.min(600, Math.round((st.posterIntervalMs||8000)/1000)));
          // Pick up default poster URL (tenant-specific or global fallback from server)
          try { DEFAULT_POSTER_URL = String(st.defaultPosterUrl||'').trim() || '/poster-default.png'; } catch { DEFAULT_POSTER_URL = '/poster-default.png'; }
          // Re-render posters to reflect updated default when tenant has no posters
          try { await loadPosters(); } catch {}
        } catch {}
      }
      async function savePosterSettings(){
        const tid = Admin.STATE.selectedTenantId; if (!tid) return;
        try {
          // Fetch current state and modify only poster fields
          const cur = await Admin.api('/drive-thru/state', { tenantId: tid });
          const tSel = document.getElementById('posterTransition');
          const iEl = document.getElementById('posterIntervalSec');
          const aEl = document.getElementById('posterAutoStart');
          const next = Object.assign({}, cur, {
            posterTransitionType: (tSel?.value||'fade'),
            posterIntervalMs: Math.max(2000, Math.min(600000, Number(iEl?.value||8)*1000)),
            posterOverlayEnabled: !!(aEl && aEl.checked)
          });
          await Admin.api(`/admin/tenants/${encodeURIComponent(tid)}/drive-thru/state`, { method:'POST', body: next, tenantId: tid });
          Admin.toast('Saved');
        } catch { Admin.toast('Save failed'); }
      }
      function fitCrop9x16(imgW, imgH){
        const target = 9/16; const src = imgW / imgH; let sx=0, sy=0, sw=imgW, sh=imgH;
        if (src > target) { // too wide -> crop width
          sw = Math.round(imgH * target); sx = Math.round((imgW - sw)/2);
        } else if (src < target) { // too tall -> crop height
          sh = Math.round(imgW / target); sy = Math.round((imgH - sh)/2);
        }
        return { sx, sy, sw, sh };
      }
      async function preparePosterBlob(file){
        return new Promise((resolve, reject) => {
          try {
            const url = URL.createObjectURL(file);
            const img = new Image(); img.onload = () => {
              try {
                const maxW = 1080, maxH = 1920; // 9:16
                const { sx, sy, sw, sh } = fitCrop9x16(img.naturalWidth||img.width, img.naturalHeight||img.height);
                const scale = Math.min(maxW/sw, maxH/sh, 1);
                const outW = Math.round(sw * scale); const outH = Math.round(sh * scale);
                const canvas = document.createElement('canvas'); canvas.width = outW; canvas.height = outH;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, sx, sy, sw, sh, 0, 0, outW, outH);
                canvas.toBlob(b => { URL.revokeObjectURL(url); b ? resolve(b) : reject(new Error('blob_failed')); }, 'image/jpeg', 0.9);
              } catch (e) { URL.revokeObjectURL(url); reject(e); }
            }; img.onerror = () => { URL.revokeObjectURL(url); reject(new Error('image_error')); }; img.src = url;
          } catch (e) { reject(e); }
        });
      }
      async function uploadPoster(file){
        const tid = Admin.STATE.selectedTenantId; if (!tid || !file) return Admin.toast('Choose a file');
        if (file.size > MAX_BYTES) { Admin.toast('Max poster size is 5 MB'); return; }
        try {
          // Resize/crop client-side to 9:16 up to 1080x1920
          const blob = await preparePosterBlob(file);
          const ct = 'image/jpeg';
          const ts = new Date();
          const pad = n => String(n).padStart(2,'0');
          const name = `poster_${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}_${pad(ts.getHours())}${pad(ts.getMinutes())}${pad(ts.getSeconds())}.jpg`;
          const sig = await Admin.api('/admin/upload-url', { method:'POST', body:{ tenant_id: tid, filename: name, kind:'poster', contentType: ct }, tenantId: tid });
          await fetch(sig.url, { method: sig.method || 'PUT', headers:{ 'Content-Type': ct }, body: blob });
        } catch (e) { throw e; }
      }
      async function uploadMultiple(files){
        const list = Array.from(files||[]);
        if (!list.length) return;
        let ok=0, fail=0;
        for (const f of list){
          try { await uploadPoster(f); ok++; } catch { fail++; }
        }
        const st = document.getElementById('status');
        if (st) st.textContent = `Uploaded ${ok}${fail?`, Failed ${fail}`:''}`;
        Admin.toast(`Uploaded ${ok}${fail?`, Failed ${fail}`:''}`);
        await loadPosters();
      }
      window.onTenantChanged = function(){ loadPosters().catch(()=>{}); };
      Admin.bootstrapAuth(function(){ loadPosters().catch(()=>{}); loadPosterSettings().catch(()=>{}); });
      const fileEl = document.getElementById('file');
      fileEl?.addEventListener('change', async ()=>{
        const fs = fileEl.files;
        try { await uploadMultiple(fs); } catch { Admin.toast('Upload failed'); }
      });
      document.getElementById('btnUpload').addEventListener('click', async ()=>{
        const fs = document.getElementById('file').files;
        try { await uploadMultiple(fs); } catch { Admin.toast('Upload failed'); }
      });
      document.getElementById('savePosterSettings')?.addEventListener('click', ()=>{ savePosterSettings().catch(()=>{}); });
    </script>
  </body>
</html>

