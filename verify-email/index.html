<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>OrderTech â€” Verify Email</title>
    <link rel="stylesheet" href="/css/admin.css" />
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    <style>
      /* Scoped tweaks for /verify-email/ */
      body[data-page='verify-email'] .card > .body { padding: 20px; }
      body[data-page='verify-email'] .input { background: #F9FAFB; border-color: #E5E7EB; min-height: 44px; }
      body[data-page='verify-email'] #verifySend.btn.primary { background:#6D28D9; border-color:#6D28D9; }
      body[data-page='verify-email'] #verifySend.btn.primary:hover { filter: brightness(0.98); }
      body[data-page='verify-email'] .page-title { font-size: 18px; line-height: 1.2; }
    </style>
    <script src="/config.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  </head>
  <body data-page="verify-email">
    <main style="max-width:460px;margin:120px auto;padding:0 16px;">
      <div style="display:grid;place-items:center;margin-bottom:28px;">
        <img src="/images/OrderTech.png" onerror="this.onerror=null;this.src='/favicon.ico';" alt="OrderTech" style="width:100px;height:100px;object-fit:contain;border-radius:8px;" />
      </div>
      <div style="text-align:center;margin-bottom:8px;">
        <h2 class="page-title" style="margin:0;">Verify your email</h2>
      </div>
      <div id="statusWrap" style="display:flex;justify-content:center;margin:10px 0;">
        <span id="msg" class="chip" style="display:none"></span>
      </div>
      <section class="card" style="width:min(360px,100%);margin:0 auto;">
        <div class="body">
          <div class="grid mt-1" style="gap:12px;">
            <label class="grid"><span class="label">Email</span>
              <input id="email" class="input" type="email" autocomplete="username email" placeholder="you@example.com" />
            </label>
            <button id="verifySend" class="btn primary" style="background:#6D28D9;border-color:#6D28D9;width:100%;">Send verification email</button>
          </div>
        </div>
      </section>
      <div class="muted" style="margin-top:6px; text-align:left; width:min(360px,100%); margin-left:auto; margin-right:auto;">
        Back to <a href="/login/" class="link" style="text-decoration:underline;">Login</a>
      </div>
    </main>

    <script>
      (function(){
        const msgEl = document.getElementById('msg');
        function setMsg(t){ if(msgEl){ msgEl.style.display = t ? 'inline-flex' : 'none'; msgEl.textContent = t||''; } }
        function ensureFirebase(){
          try {
            if (!window.firebase) return null;
            if (!firebase.apps?.length) firebase.initializeApp(window.firebaseConfig||{});
            return firebase;
          } catch { return window.firebase||null; }
        }
        const fb = ensureFirebase();
        const el = (id)=>document.getElementById(id);
        const actionCodeSettings = { url: window.location.origin + '/login/?mode=verifyEmail', handleCodeInApp: true };

        // Prefill from query param
        try {
          const u = new URL(window.location.href);
          const em = (u.searchParams.get('email')||'').trim();
          if (em) { const e = el('email'); if (e && !e.value) e.value = em; }
        } catch {}

        async function onSend(){
          const email = (el('email')?.value||'').trim();
          if (!email || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) { setMsg('Enter a valid email'); el('email')?.focus(); return; }
          const btn = el('verifySend'); if (btn) { btn.disabled = true; btn.textContent = 'Sending...'; }
          try {
            const r = await fetch('/auth/send-verification-email', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email }) });
            if (r.ok) {
              try { const j = await r.json(); if (j && j.link) {
                setMsg('Email sending not configured here. Use this link to verify:');
                const a = document.createElement('a'); a.href=j.link; a.textContent='Open verification link'; a.target='_blank';
                const wrap = document.getElementById('statusWrap'); if (wrap) { wrap.appendChild(document.createElement('br')); wrap.appendChild(a); }
              } else {
                setMsg('Verification email sent. Please check your inbox.');
              } } catch { setMsg('Verification email sent.'); }
            } else { setMsg('Could not send verification. Try again.'); }
          } catch (e) {
            setMsg('Could not send verification. Try again.');
          } finally {
            const btn2 = el('verifySend'); if (btn2) { btn2.disabled = false; btn2.textContent = 'Send verification email'; }
          }
        }

        el('verifySend')?.addEventListener('click', (e)=>{ e.preventDefault(); onSend(); });
        document.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ onSend(); }});
      })();
    </script>
  </body>
</html>

