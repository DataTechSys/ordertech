<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Complete your profile</title>
  <link rel="stylesheet" href="/css/admin.css">
  <style>
    .card { max-width: 420px; margin: 40px auto; padding: 24px; background: #fff; border-radius: 8px; box-shadow: 0 4px 16px rgba(0,0,0,0.08); }
    .brand { text-align: center; margin-bottom: 16px; font-weight: 700; font-size: 20px; }
    .row { margin-bottom: 12px; }
    .row label { display:block; margin-bottom:6px; font-weight:600; }
    .row input { width: 100%; padding: 10px 12px; border:1px solid #ddd; border-radius: 6px; }
    .btn { padding: 10px 14px; border:none; background:#1f6feb; color:#fff; border-radius:6px; cursor:pointer; }
    .muted { color:#666; font-size: 13px; }
    .ok { color: #137333; }
    .err { color: #b00020; }
  </style>
</head>
<body data-page="profile">
  <main style="max-width:460px;margin:120px auto;padding:0 16px;">
    <div style="display:grid;place-items:center;margin-bottom:28px;">
      <img src="/images/OrderTech.png" onerror="this.onerror=null;this.src='/favicon.ico';" alt="OrderTech" style="width:100px;height:100px;object-fit:contain;border-radius:8px;" />
    </div>
    <section class="card" style="width:min(420px,100%);margin:0 auto;">
      <div class="body">
        <div style="text-align:center;margin-bottom:8px;">
          <h2 class="page-title" style="margin:0; font-size:18px; line-height:1.2;">Complete your profile</h2>
        </div>
        <div id="statusWrap" style="display:flex;justify-content:center;margin:10px 0;">
          <span id="msg" class="chip" style="display:none"></span>
        </div>
        <div class="grid" style="gap:12px;">
          <div class="row" style="display:grid; grid-template-columns: 96px 1fr; gap:12px; align-items:center;">
            <div style="position:relative; width:96px; height:96px; border-radius:999px; overflow:hidden; border:1px solid #e5e7eb; background:#f3f4f6;">
              <img id="avatarPreview" alt="Avatar" style="width:100%; height:100%; object-fit:cover; display:block;">
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <input id="avatarFile" type="file" accept="image/*" capture="user" style="display:none;"/>
              <button id="btnPickAvatar" class="btn" type="button">Choose Photo</button>
              <button id="btnCameraAvatar" class="btn" type="button">Take Photo</button>
              <button id="btnRemoveAvatar" class="btn danger" type="button">Remove</button>
            </div>
          </div>
          <label class="grid"><span class="label">Full name</span>
            <input id="name" class="input" placeholder="Your name" />
          </label>
          <label class="grid"><span class="label">Mobile (+CountryCode)</span>
            <input id="mobile" class="input" placeholder="+9655xxxxxxx" />
          </label>
          <button id="saveBtn" class="btn primary" style="width:100%;">Save</button>
        </div>
      </div>
    </section>
  </main>

  <script src="/config.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script>
    (function(){
      const _msgEl = document.getElementById('msg');
      const msg = (t, cls='muted') => { if (_msgEl) { _msgEl.style.display = t ? 'inline-flex' : 'none'; _msgEl.className = 'chip ' + (cls||''); _msgEl.textContent = t || ''; } };
      function ensureFirebase(){ try { if(!window.firebase) return null; if(!firebase.apps?.length) firebase.initializeApp(window.firebaseConfig||{}); return firebase; } catch { return window.firebase||null; } }
      const fb = ensureFirebase();
      function idToken(){ return fb?.auth && fb.auth().currentUser ? fb.auth().currentUser.getIdToken(true) : Promise.resolve(localStorage.getItem('ID_TOKEN')||''); }
      function nextPath(){ try { const u = new URL(window.location.href); return u.searchParams.get('next') || ''; } catch { return ''; } }

      let avatarUrl = '';
      function fitSquare(w, h){ const s=Math.min(w,h); const sx=Math.round((w-s)/2); const sy=Math.round((h-s)/2); return { sx, sy, s }; }
      async function prepareAvatarBlob(file){
        return new Promise((resolve, reject) => {
          try {
            const url = URL.createObjectURL(file);
            const img = new Image(); img.onload = () => {
              try {
                const { sx, sy, s } = fitSquare(img.naturalWidth||img.width, img.naturalHeight||img.height);
                const out = 512;
                const canvas = document.createElement('canvas'); canvas.width = out; canvas.height = out;
                const ctx = canvas.getContext('2d'); ctx.drawImage(img, sx, sy, s, s, 0, 0, out, out);
                canvas.toBlob(b => { URL.revokeObjectURL(url); b ? resolve(b) : reject(new Error('blob_failed')); }, 'image/jpeg', 0.92);
              } catch (e) { URL.revokeObjectURL(url); reject(e); }
            }; img.onerror = () => { URL.revokeObjectURL(url); reject(new Error('image_error')); }; img.src = url;
          } catch (e) { reject(e); }
        });
      }
      async function uploadAvatar(file){
        const tok = await idToken();
        const blob = await prepareAvatarBlob(file);
        const filename = 'avatar.jpg';
        const r = await fetch('/auth/avatar/upload-url', { method:'POST', headers:{ 'Content-Type':'application/json', ...(tok?{Authorization:'Bearer '+tok}:{}) }, body: JSON.stringify({ filename, contentType: 'image/jpeg' }) });
        const sig = await r.json();
        await fetch(sig.url, { method: sig.method || 'PUT', headers:{ 'Content-Type': 'image/jpeg' }, body: blob });
        avatarUrl = sig.publicUrl || '';
        const img = document.getElementById('avatarPreview'); if (img) img.src = avatarUrl;
        msg('Photo uploaded','ok');
      }

      const fileEl = document.getElementById('avatarFile');
      document.getElementById('btnPickAvatar')?.addEventListener('click', ()=>{ if (fileEl) fileEl.click(); });
      document.getElementById('btnCameraAvatar')?.addEventListener('click', ()=>{ if (fileEl) { try { fileEl.setAttribute('capture','user'); } catch {}; fileEl.click(); } });
      document.getElementById('btnRemoveAvatar')?.addEventListener('click', ()=>{ const img=document.getElementById('avatarPreview'); if(img){ img.src=''; } avatarUrl=''; });
      fileEl?.addEventListener('change', async ()=>{ const f=fileEl.files && fileEl.files[0]; if (f) { try { await uploadAvatar(f); } catch { msg('Upload failed','err'); } } });

      // Save profile
      document.getElementById('saveBtn')?.addEventListener('click', async ()=>{
        const full_name = (document.getElementById('name').value||'').trim();
        const mobile = (document.getElementById('mobile').value||'').trim();
        try {
          msg('Saving...');
          const tok = await idToken();
          const res = await fetch('/auth/profile', { method:'POST', headers:{ 'Content-Type':'application/json', ...(tok?{Authorization:'Bearer '+tok}:{}) }, body: JSON.stringify({ full_name, mobile, photo_url: avatarUrl }) });
          if (!res.ok) throw new Error('failed');
          msg('Saved','ok');
          const next = nextPath();
          setTimeout(()=>{ window.location.href = next || '/products/'; }, 500);
        } catch { msg('Save failed','err'); }
      });
    })();
  </script>
</body>
</html>

